---
- name: MDR-RA DataSHIELD/Opal Installation Playbook
  hosts: localhost
  vars_files:
    - default_settings.yml
    - custom_settings.yml
    - container-images.yml
  vars:
    install_dir: "mdr-ra"
    install_dir_path: "/opt/{{ install_dir }}"
    storage_dir_path_list:
      - "{{ install_dir_path }}/db/opal"
      - "{{ install_dir_path }}/db/mongo"
      - "{{ install_dir_path }}/db/postgres"
    quadlets_dir_path: "/etc/containers/systemd/users/{{ datashield_uid }}"
    bitnami_container_internal_uid: 1001
  gather_facts: true

  tasks:
    # -----------------------------------------------------------------------------
    - name: Gather OS data into ansible facts
      tags: ['always']
      block:
        - name: Display some collected facts
          ansible.builtin.debug:
            msg: |
              Distribution: {{ ansible_facts.distribution }}
              Version: {{ ansible_facts.distribution_version }}
              Release: {{ ansible_facts.distribution_release }}
              OS Family: {{ ansible_facts.os_family }}
              Kernel: {{ ansible_facts.kernel }}
              Architecture: {{ ansible_facts.architecture }}
              Memory Total: {{ ansible_facts.memtotal_mb }} MB
              Processor Count: {{ ansible_facts.processor_count }}

        - name: Kill play execution if not running on target distribution
          ansible.builtin.meta: end_play
          when:
            - ansible_facts.distribution != "Ubuntu"
            - ansible_facts.distribution_major_version != "24"
    # -----------------------------------------------------------------------------
    - name: System Package Management and Updates (Ubuntu 24)
      become: true
      block:
        - name: Install aptitude
          ansible.builtin.apt:
            name:
              - aptitude
            state: latest
            update_cache: true
          tags: ['always']

        - name: Install required system packages
          ansible.builtin.apt:
            name:
              - acl
              - ca-certificates
              - curl
              - dbus-user-session
              - gnupg
              - lsb-release
              - openssl
              - podman
              - systemd-container
              - ufw
              - uidmap
              - unattended-upgrades
            state: latest
          tags: ['always']

        - name: Enable automatic system updates
          ansible.builtin.debconf:
            name: unattended-upgrades
            question: unattended-upgrades/enable_auto_updates
            vtype: boolean
            value: 'true'
          tags: ['always']

        - name: Add configuration file for automatic system updates
          ansible.builtin.command:
            cmd: dpkg-reconfigure -f noninteractive unattended-upgrades
            creates: /etc/apt/apt.conf.d/20auto-upgrades
          tags: ['always']
    # -----------------------------------------------------------------------------
    - name: SSH Configuration
      become: true
      block:
        - name: Backup in use configurations
          ansible.builtin.copy:
            src: "/etc/ssh/sshd_config"
            dest: "/etc/ssh/sshd_config.d/sshd_config.bkp"
            remote_src: true
            backup: yes
          tags: ['always']

        - name: Disable SSH server configuration import
          ansible.builtin.lineinfile:
            path: '/etc/ssh/sshd_config'
            regex: '^(#)?{{ item }} (.*)'
            line: '#{{ item }} \2 # no cloud init thanks'
            backrefs: yes
            state: present
          loop:
            - "Include"

        - name: Reconfigure the SSH server
          ansible.builtin.lineinfile:
            path: '/etc/ssh/sshd_config'
            regex: '^(#)?{{item.key}} (.*)'
            line: '{{item.key}} {{item.value}} # was \2'
            backrefs: yes
            state: present
          loop:
            - {key: "PasswordAuthentication", value: "no"}
            - {key: "KbdInteractiveAuthentication", value: "no"}
            - {key: "ChallengeResponseAuthentication", value: "no"}
            - {key: "PubkeyAuthentication", value: "yes"}
            - {key: "PermitRootLogin", value: "no"}
            - {key: "GSSAPIAuthentication", value: "no"}
            - {key: "X11Forwarding", value: "no"}
            - {key: "UsePAM", value: "yes"}

        - name: Restart SSH
          ansible.builtin.systemd_service:
            name: ssh.service
            state: restarted
            enabled: true
          tags: ['always']
    # -----------------------------------------------------------------------------
    - name: DataSHIELD User and Directory Setup
      become: true
      block:
        - name: Create a dedicated MDR-RA DataSHIELD user
          ansible.builtin.user:
            name: "{{ datashield_username }}"
            uid: "{{ datashield_uid }}"
            shell: /bin/bash
            create_home: true
          tags: ['always']

        - name: Enable lingering for the MDR-RA DataSHIELD user
          ansible.builtin.command:
            cmd: "loginctl enable-linger {{ datashield_username }}"
            creates: "/var/lib/systemd/linger/{{ datashield_username }}"
          tags: ['always']

        - name: Create required directories for DataSHIELD setup files
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            owner: "{{ datashield_username }}"
            group: "{{ datashield_username }}"
            mode: '0750'
          loop:
            - "{{ install_dir_path }}/nginx"
            - "{{ install_dir_path }}/nginx_logs"
            - "{{ install_dir_path }}/https"
            - "{{ install_dir_path }}/https/ca"
            - "{{ install_dir_path }}/https/cert"
          tags: ['always']

        - name: Create required directories for DataSHIELD data storage
          become_user: "{{ datashield_username }}"
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            mode: '0750'
          loop: "{{ storage_dir_path_list }}"
          tags: ['always']

        - name: Set ownership for DB data directories owned by non-root users
          become_user: "{{ datashield_username }}"
          ansible.builtin.command: "podman unshare chown -R 1001:1001 {{ item }}"
          with_items:
            - "{{ install_dir_path }}/db/mongo"
            - "{{ install_dir_path }}/db/postgres"
          tags: ['always']
    # -----------------------------------------------------------------------------
    - name: HTTPS Certificate Management
      block:
        - name: Delete existing certificates (manual trigger)
          become: true
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - "{{ install_dir_path }}/https/cert/privkey.pem"
            - "{{ install_dir_path }}/https/cert/fullchain.pem"
          tags: ['never', 'delete_https_certs']

        - name: Check existing and user-provided certificates
          block:
            - name: Check if privkey.pem is already installed
              become: true
              ansible.builtin.stat:
                path: "{{ install_dir_path }}/https/cert/privkey.pem"
              register: https_installed_privkey
              tags: ['always']

            - name: Check if fullchain.pem is already installed
              become: true
              ansible.builtin.stat:
                path: "{{ install_dir_path }}/https/cert/fullchain.pem"
              register: https_installed_fullchain
              tags: ['always']

            - name: Check if a valid privkey.pem is provided
              ansible.builtin.stat:
                path: "cert/privkey.pem"
              register: https_user_provided_cert_privkey
              tags: ['always']

            - name: Check if a valid fullchain.pem is provided
              become_user: "{{ datashield_username }}"
              ansible.builtin.stat:
                path: "cert/fullchain.pem"
              register: https_user_provided_cert_fullchain
              tags: ['always']

        - name: Install user-provided certificates
          when:
            - not https_installed_privkey.stat.exists
            - not https_installed_fullchain.stat.exists
            - https_user_provided_cert_privkey.stat.exists
            - https_user_provided_cert_fullchain.stat.exists
          become: true
          block:
            - name: Copy user-provided HTTPS private key and certificate
              ansible.builtin.copy:
                src: "cert/{{ item }}"
                dest: "{{ install_dir_path }}/https/cert"
                owner: "{{ datashield_username }}"
                group: "{{ datashield_username }}"
              loop:
                - privkey.pem
                - fullchain.pem
              tags: ['always']

            - name: Set permissions for the user-provided privkey.pem
              ansible.builtin.file:
                dest: "{{ install_dir_path }}/https/cert/privkey.pem"
                owner: "{{ datashield_username }}"
                group: "{{ datashield_username }}"
                mode: '0600'
              tags: ['always']

            - name: Set permissions for the user-provided fullchain.pem
              ansible.builtin.file:
                dest: "{{ install_dir_path }}/https/cert/fullchain.pem"
                owner: "{{ datashield_username }}"
                group: "{{ datashield_username }}"
                mode: '0644'
              tags: ['always']

        - name: Generate self-signed certificates
          when:
            - not https_installed_privkey.stat.exists
            - not https_installed_fullchain.stat.exists
            - not https_user_provided_cert_privkey.stat.exists
            - not https_user_provided_cert_fullchain.stat.exists
          become: true
          become_user: "{{ datashield_username }}"
          block:
            - name: HTTPS - Create private CA key with password protection
              community.crypto.openssl_privatekey:
                path: "{{ install_dir_path }}/https/ca/ca-certificate.key"
                passphrase: "{{ datashield_username }}"
                cipher: auto
              tags: ['always']

            - name: HTTPS - Create signing request (CSR) for CA certificate
              community.crypto.openssl_csr_pipe:
                privatekey_path: "{{ install_dir_path }}/https/ca/ca-certificate.key"
                privatekey_passphrase: "{{ datashield_username }}"
                common_name: MDR-RA CA
                use_common_name_for_san: false
                basic_constraints:
                  - 'CA:TRUE'
                basic_constraints_critical: true
                key_usage:
                  - keyCertSign
                key_usage_critical: true
              register: ca_csr
              tags: ['always']

            - name: HTTPS - Create self-signed CA certificate from CSR
              community.crypto.x509_certificate:
                path: "{{ install_dir_path }}/https/ca/ca-certificate.pem"
                csr_content: "{{ ca_csr.csr }}"
                privatekey_path: "{{ install_dir_path }}/https/ca/ca-certificate.key"
                privatekey_passphrase: "{{ datashield_username }}"
                provider: selfsigned
              tags: ['always']

            - name: HTTPS - Create .crt CA certificate from PEM
              shell: "openssl x509 -inform PEM -in {{ install_dir_path }}/https/ca/ca-certificate.pem -out {{ install_dir_path }}/https/ca/ca-certificate.crt"
              tags: ['always']

            - name: HTTPS - Create a private key for the new certificate
              community.crypto.openssl_privatekey:
                path: "{{ install_dir_path }}/https/cert/privkey.pem"
              run_once: true
              tags: ['always']

            - name: HTTPS - Create the certificate signing request (CSR)
              community.crypto.openssl_csr_pipe:
                privatekey_path: "{{ install_dir_path }}/https/cert/privkey.pem"
                subject_alt_name:
                  - "DNS:{{ domain_name }}"
                  - "DNS:mdr-ra.local"
                  - "DNS:datashield.local"
                  - "DNS:opal.local"
              run_once: true
              register: csr
              tags: ['always']

            - name: HTTPS - Sign certificate with our CA
              community.crypto.x509_certificate_pipe:
                csr_content: "{{ csr.csr }}"
                provider: ownca
                ownca_path: "{{ install_dir_path }}/https/ca/ca-certificate.pem"
                ownca_privatekey_path: "{{ install_dir_path }}/https/ca/ca-certificate.key"
                ownca_privatekey_passphrase: "{{ datashield_username }}"
                ownca_not_after: +3650d
                ownca_not_before: "-1d"
              run_once: true
              register: certificate
              tags: ['always']

            - name: HTTPS - Write certificate file
              copy:
                dest: "{{ install_dir_path }}/https/cert/fullchain.pem"
                content: "{{ certificate.certificate }}"
              run_once: true
              tags: ['always']
    # -----------------------------------------------------------------------------
    - name: Hosts configuration
      become: true
      block:
        - name: Fetching public IP address
          shell: ip addr show scope global | awk '/inet/ { ip = $2; sub(/\/.*/, "", ip); print ip }' | head -n 1
          register: public_ip_addr
          tags: ['always']

        - name: Print public IP address
          debug:
            var: public_ip_addr.stdout
          tags: ['always']

        - name: Update /etc/hosts with a resolvable service name (mdr-ra)
          lineinfile:
            path: /etc/hosts
            regexp: "host"
            line: "{{ public_ip_addr.stdout }} {{ domain_name }}"
            state: present
          tags: ['always']
    # -----------------------------------------------------------------------------
    - name: Firewall Configuration (UFW) / Ubuntu 24
      become: true
      block:
        - name: Reset
          community.general.ufw:
            state: reset
          tags: ['always']

        - name: Allow outgoing connections
          community.general.ufw:
            default: allow
            direction: outgoing
          tags: ['always', 'firewall']

        - name: Block incoming connections
          community.general.ufw:
            default: deny
            direction: incoming
          tags: ['always', 'firewall']

        - name: Allow DataSHIELD HTTPS connections
          community.general.ufw:
            rule: allow
            direction: in
            port: '{{ public_https_port }}'
            proto: tcp
            from_ip: '{{ item }}'
          loop: "{{ allowed_https_client_networks }}"
          tags: ['public_ip', 'firewall']
          when: "'public_ip' in ansible_run_tags"

        - name: Enable rate limiting for the DataSHIELD HTTPS interface
          community.general.ufw:
            rule: limit
            port: '{{ public_https_port }}'
            proto: tcp
          tags: ['public_ip', 'firewall']
          when: "'public_ip' in ansible_run_tags"

        - name: Allow SSH connections for system administrators
          community.general.ufw:
            rule: allow
            direction: in
            port: 22
            proto: tcp
            from_ip: '{{ item }}'
          loop: "{{ allowed_ssh_client_networks }}"
          tags: ['always', 'firewall']

        - name: Enable Firewall
          community.general.ufw:
            state: enabled
          tags: ['always', 'firewall']
    # -----------------------------------------------------------------------------
    - name: Application File Copy and Configuration
      become: true
      block:
        - name: Copy installation and configuration files - datashield-opal-kube.yml
          ansible.builtin.copy:
            src: "files/datashield-opal-kube.yml"
            dest: "{{ install_dir_path }}"
            owner: "{{ datashield_username }}"
            group: "{{ datashield_username }}"
          tags: ['always']

        - name: Set the desired HTTPS service port
          ansible.builtin.replace:
            path: "{{ install_dir_path }}/datashield-opal-kube.yml"
            regexp: '^(\s*hostPort:) .* (# ANSIBLE REPLACE MARKER HTTPS PORT)'
            replace: '\1 {{ public_https_port }} \2'
          tags: ['always']

        - name: Set the right image version for opal
          ansible.builtin.replace:
            path: "{{ install_dir_path }}/datashield-opal-kube.yml"
            regexp: '^(\s*image:) .* (# ANSIBLE REPLACE MARKER OPAL IMAGE)'
            replace: '\1 "{{ opal_image_tag }}" \2'
          tags: ['always']

        - name: Set the right image version for postgres
          ansible.builtin.replace:
            path: "{{ install_dir_path }}/datashield-opal-kube.yml"
            regexp: '^(\s*image:) .* (# ANSIBLE REPLACE MARKER POSTGRES IMAGE)'
            replace: '\1 "{{ postgres_image_tag }}" \2'
          tags: ['always']

        - name: Set the right image version for rock
          ansible.builtin.replace:
            path: "{{ install_dir_path }}/datashield-opal-kube.yml"
            regexp: '^(\s*image:) .* (# ANSIBLE REPLACE MARKER ROCK IMAGE)'
            replace: '\1 "{{ rock_image_tag }}" \2'
          tags: ['always']

        - name: Set the right image version for nginx
          ansible.builtin.replace:
            path: "{{ install_dir_path }}/datashield-opal-kube.yml"
            regexp: '^(\s*image:) .* (# ANSIBLE REPLACE MARKER NGINX IMAGE)'
            replace: '\1 "{{ nginx_image_tag }}" \2'
          tags: ['always']

        - name: Copy installation and configuration files - NGINX files
          ansible.builtin.copy:
            src: "files/nginx/{{ item }}"
            dest: "{{ install_dir_path }}/nginx"
            owner: "{{ datashield_username }}"
            group: "{{ datashield_username }}"
          loop:
            - server.conf
            - rules.conf
          tags: ['always']

        - name: Set ownership for the HTTPS private key
          become_user: "{{ datashield_username }}"
          ansible.builtin.command: "podman unshare chown 1001:1001 {{ install_dir_path }}/https/cert/privkey.pem"
          tags: ['always']

        - name: Set ownership for the HTTPS certificate
          become_user: "{{ datashield_username }}"
          ansible.builtin.command: "podman unshare chown 1001:1001 {{ install_dir_path }}/https/cert/fullchain.pem"
          tags: ['always']

        - name: Create a dedicated Podman network
          become_user: "{{ datashield_username }}"
          containers.podman.podman_network:
            name: "{{ podman_network }}"
          tags: ['always']

        - name: Create required directories for DataSHIELD setup files
          ansible.builtin.file:
            path: "{{ quadlets_dir_path }}"
            state: directory
            owner: "{{ datashield_username }}"
            group: "{{ datashield_username }}"
            mode: '0750'
          tags: ['always']

        - name: Copy quadlet files to install location
          ansible.builtin.copy:
            src: "files/opal-datashield.kube"
            dest: "{{ quadlets_dir_path }}"
            owner: "{{ datashield_username }}"
            group: "{{ datashield_username }}"
          tags: ['always']
    # -----------------------------------------------------------------------------
    - name: Pull container images
      become: true
      become_user: "{{ datashield_username }}"
      containers.podman.podman_image:
        name: "{{ item }}"
      loop:
        - "{{ opal_image_tag }}"
        - "{{ postgres_image_tag }}"
        - "{{ rock_image_tag }}"
        - "{{ nginx_image_tag }}"
      tags: ['always']
    # -----------------------------------------------------------------------------
    - name: Service Management
      become: true
      become_user: "{{ datashield_username }}"
      block:
        - name: If present, stop the service
          ansible.builtin.systemd_service:
            scope: "user"
            name: "opal-datashield.service"
            state: "started"
          ignore_errors: true
          tags: ['always']

        - name: Reload systemd daemon and create service definitions
          ansible.builtin.systemd_service:
            daemon_reload: true
            scope: "user"
          tags: ['always']

        - name: Start the service
          ansible.builtin.systemd_service:
            scope: "user"
            name: "opal-datashield.service"
            state: "started"
          tags: ['always']
